var __awaiter=this&&this.__awaiter||function(e,r,c,l){return new(c=c||Promise)(function(o,t){function n(e){try{a(l.next(e))}catch(e){t(e)}}function i(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?o(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(n,i)}a((l=l.apply(e,r||[])).next())})};__awaiter(this,void 0,void 0,function*(){const i=!/test|debug|dev|localhost|127\.0\.0\.1/i.test(location.href),e=(i||console.warn("You are in the developing mode."),location.search&&URL&&(t=new URL(location.href).searchParams.get("referer"))&&(document.cookie=`referer=${t};path=/`),yield fetch("/api/login/params").then(e=>e.json()));if(e.domain===location.origin||/^https:\/\/localhost.iconlake.com:\d+$/.test(location.origin)){const n=encodeURIComponent(location.origin);var t=document.querySelector(".auth .gitee"),t=(e.login.gitee?(t.classList.add("active"),t.addEventListener("click",()=>{location.href=`https://gitee.com/oauth/authorize?client_id=${e.clientId.gitee}&redirect_uri=${n}%2Fapi%2Foauth%2Fgitee&response_type=code`})):t.style.display="none",document.querySelector(".auth .github")),t=(e.login.github?(t.classList.add("active"),t.addEventListener("click",()=>{location.href=`https://github.com/login/oauth/authorize?client_id=${e.clientId.github}&redirect_uri=${n}%2Fapi%2Foauth%2Fgithub`})):t.style.display="none",document.querySelector(".auth .google")),t=(e.login.google?(t.classList.add("active"),t.addEventListener("click",()=>{location.href=`https://accounts.google.com/o/oauth2/v2/auth?scope=${encodeURIComponent("https://www.googleapis.com/auth/userinfo.profile")}&access_type=offline&include_granted_scopes=true&response_type=code&state=${e.nonce}&client_id=${encodeURIComponent(e.clientId.google)}&redirect_uri=${n}%2Fapi%2Foauth%2Fgoogle`})):t.style.display="none",document.querySelector(".auth .code")),o=(e.login.code?(t.classList.add("active"),t.addEventListener("click",()=>{const t=document.querySelector(".prompt");if(t){t.style.display="flex";const o=t.querySelector("input");o&&(o.setAttribute("placeholder","Input Code"),o.focus(),o.onkeyup=e=>{"Enter"===e.key&&(t.style.display="none",e=o.value)&&(location.href="/api/oauth/code?id="+e)})}})):t.style.display="none",document.querySelector(".auth .keplr")),o=(e.login.keplr?(o.classList.add("active"),"keplr"in window||o.classList.add("uninstall"),o.addEventListener("click",()=>__awaiter(this,void 0,void 0,function*(){if("keplr"in window){var t=window.keplr,o=i?"iconlake-1":"iconlake-testnet-1";try{yield t.enable(o)}catch(e){var n=yield fetch(`/common/chain-${i?"main":"test"}net.json`).then(e=>e.json());yield t.experimentalSuggestChain(n),yield new Promise(e=>{setTimeout(e,200)}),yield t.enable(o)}var n=yield t.getOfflineSigner(o).getAccounts(),e=`Login iconLake
${(new Date).toISOString()}
`+n[0].address,t=yield t.signArbitrary(o,n[0].address,e);a(!0),fetch("/api/oauth/blockchain",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({msg:e,sig:t.signature,pubkey:t.pub_key})}).then(e=>e.json()).then(e=>{e.error?(a(!1),alert(e.error)):window.location.href=e.redirect})}else location.href="https://www.keplr.app/download"}))):t.style.display="none",document.querySelector(".auth .webAuthn")),t=(e.login.webAuthn?(o.classList.add("active"),null!=(t=o.querySelector(".create"))&&t.addEventListener("click",e=>{var t=new Date,t=`iconLake Creator (${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()} ${t.getHours()}:${t.getMinutes()})`;return navigator.credentials.create({publicKey:{rp:{name:"iconLake"},challenge:(new TextEncoder).encode(`Login iconLake
`+(new Date).toISOString()),user:{id:(new TextEncoder).encode(t),name:t,displayName:t},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],timeout:6e4,attestation:"none"}}).then(e=>{a(!0),fetch("/api/oauth/webAuthn/register",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{e.error?(a(!1),alert(e.error)):window.location.href=e.redirect})}),e.stopPropagation(),!1}),o.addEventListener("click",()=>{navigator.credentials.get({publicKey:{challenge:(new TextEncoder).encode(`Login iconLake
`+(new Date).toISOString()),allowCredentials:[]}}).then(e=>{e=JSON.stringify(e);a(!0),fetch("/api/oauth/webAuthn/login",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:e}).then(e=>e.json()).then(e=>{e.error?(a(!1),alert(e.error)):window.location.href=e.redirect})})})):o.style.display="none",document.querySelector(".auth .mail"));if(e.login.mail){t.classList.add("active"),t.addEventListener("click",()=>{var e=document.querySelector(".prompt.mail");e&&(e.style.display="flex",e=e.querySelector("input"))&&e.focus()});const s=document.querySelector("#mail-send");let o=!1;s.addEventListener("click",()=>__awaiter(this,void 0,void 0,function*(){var e,t;o||(o=!0,s.innerText=s.dataset.loadingText,(t=(e=document.querySelector('.prompt.mail input[type="email"]')).value)?(t=yield fetch("/api/oauth/mail/send",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({mail:t})}).then(e=>e.json())).error?(console.error(t.error),s.innerText=s.dataset[t.error.toLowerCase()+"Text"]||t.error):s.innerText=s.dataset.doneText:(e.focus(),o=!1,s.innerText=s.dataset.defaultText))}));const d=document.querySelector("#mail-login");let i=!1;d.addEventListener("click",()=>__awaiter(this,void 0,void 0,function*(){var e,t,o,n;i||(i=!0,d.innerText=d.dataset.loadingText,(n=(e=document.querySelector('.prompt.mail input[type="email"]')).value)?(o=(t=document.querySelector('.prompt.mail input[type="password"]')).value)?(n=yield fetch("/api/oauth/mail/login",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({mail:n,password:o})}).then(e=>e.json())).error?(console.error(n.error),d.innerText="fail"===n.error?d.dataset.failText:n.error,i=!1):window.location.href=n.redirect:(t.focus(),i=!1,d.innerText=d.dataset.defaultText):(e.focus(),i=!1,d.innerText=d.dataset.defaultText))}))}else t.style.display="none";document.body.addEventListener("click",e=>{e.target&&(e=e.target).classList.contains("prompt")&&(e.style.display="none")});const r=document.querySelector("#loading"),c=document.querySelector("#items"),l=Date.now();function a(e){e?(r.classList.remove("hide"),c.classList.add("hide")):(r.classList.add("hide"),c.classList.remove("hide"))}fetch("/api/user/info").then(e=>e.json()).then(e=>{setTimeout(()=>{e.error?a(!1):location.href="/manage/home"},1e3-(Date.now()-l))})}else location.href=""+e.domain+location.pathname});