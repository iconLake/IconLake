import{d as Je,u as Qe,m as $,r as Xe,p as Le,o as Ze,c as r,b as a,t as l,e,l as w,F as b,v as y,f as v,B as Pe,C as Se,i as je,z as et,k as s,_ as tt}from"./index.c3ac6b9b.js";import{u as h,z as u,t as B,h as at}from"./cache.05004cf3.js";import{L as _}from"./Loading.7dd0339b.js";import{g as it}from"./blockchain.f881c816.js";import{s as ot}from"./blockchain.62e14144.js";import{u as nt}from"./user.237cd0b6.js";import"./@iconlake/client.0b258216.js";import"./index.9c1809da.js";const st={class:"item"},lt={class:"item-label"},rt={class:"item-value flex"},ct={key:0,class:"item"},dt={class:"item-label"},ut={class:"item-value flex"},mt={class:"flex center"},gt={key:1,class:"item"},vt={class:"item-value flex"},ht={class:"flex center"},ft=["src","alt"],pt={key:2,class:"item"},bt={key:0,class:"alert"},wt={class:"item-value flex"},yt={class:"flex center"},_t=["src","alt"],kt={key:3,class:"item"},Bt={class:"item-value flex"},Ct={class:"flex center"},$t=["src","alt"],xt={key:4,class:"item"},Ft={class:"item-value flex"},At=["placeholder"],Et=["placeholder"],Mt={key:5,class:"item"},Dt={class:"item-value flex"},Tt={class:"item"},Gt={class:"item-value flex"},It=Je({__name:"Bind",setup(Kt){const{t:n}=Qe(),{userInfo:i,refreshUserInfo:A}=nt(),d=$(),m=Xe({gitee:!1,github:!1,blockchain:!1,code:!1,accessKey:!1,google:!1,webAuthn:!1,mail:!1}),f=$({mail:"",password:""}),E=$(null),x=$(0),F=$(n("sendPasswordToEmail")),Ue=je(),M=Le(()=>et.global.locale.value==="zh-cn"?"\u5FC5\u987B\u7ED1\u5B9AGitee\u624D\u80FD\u4F7F\u7528\u5168\u90E8\u529F\u80FD":""),ze=Le(()=>{let o=0;return Object.values(u).forEach(t=>{var c;(c=i==null?void 0:i[t])!=null&&c.id&&o++}),o});Ze(async()=>{await Promise.all([h.loginParams().onUpdate(async o=>{d.value=o})]),Ue.end()});async function Ve(o){if(!d.value)throw new Error("no login params");switch(o){case u.Mail:return await Ne();case u.Blockchain:return await He();case u.WebAuthn:return await We();case u.Google:document.cookie=`referer=${location.href};path=/`,location.href=`https://accounts.google.com/o/oauth2/v2/auth?scope=${encodeURIComponent("https://www.googleapis.com/auth/userinfo.profile")}&access_type=offline&include_granted_scopes=true&response_type=code&state=${d.value.nonce}&client_id=${encodeURIComponent(d.value.clientId.google)}&redirect_uri=${d.value.domain}%2Fapi%2Foauth%2Fgoogle`;return;case u.Gitee:document.cookie=`referer=${location.href};path=/`,location.href=`https://gitee.com/oauth/authorize?client_id=${d.value.clientId.gitee}&redirect_uri=${d.value.domain}%2Fapi%2Foauth%2Fgitee&response_type=code`;return;case u.Github:document.cookie=`referer=${location.href};path=/`,location.href=`https://github.com/login/oauth/authorize?client_id=${d.value.clientId.github}&redirect_uri=${d.value.domain}%2Fapi%2Foauth%2Fgithub`;return;case u.Code:return await Oe();default:throw new Error("no type")}}async function Ne(){await new Promise((o,t)=>{at(E.value,async()=>{if(!f.value.mail||!f.value.password){t({error:"argsError"});return}const c=await h.mailLogin({mail:f.value.mail,password:f.value.password}).catch(g=>g);if(c.error){t();return}c.userId!==i._id&&(B(n("alreadyBoundAndSwitch")),h.clearCache(),await new Promise(()=>{setTimeout(()=>{location.reload()},2e3)})),o(void 0)},{cancel:()=>{t({error:"cancel"})}})})}async function Re(){if(x.value!==0||!f.value.mail)return;x.value=1,F.value=n("sending");const o=await h.sendMail({mail:f.value.mail}).catch(t=>t);if(o.error){F.value=n(o.error),x.value=0;return}x.value=2,F.value=n("sendMailDone")}async function We(){const o=new Date,t=i.name||`iconLake Creator (${o.getFullYear()}/${o.getMonth()+1}/${o.getDate()} ${o.getHours()}:${o.getMinutes()})`,c=await navigator.credentials.create({publicKey:{rp:{name:"iconLake"},challenge:new TextEncoder().encode(`Login iconLake
${new Date().toISOString()}`),user:{id:new TextEncoder().encode(t),name:t,displayName:t},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],timeout:6e4,attestation:"none"}}),g=await h.webAuthnRegister(c);if(!g||g.error)throw new Error("login error")}async function Oe(){const o=prompt(n("pleaseInputCode"));if(!o)throw new Error("no code");const t=await h.loginByCode({code:o});if(!t||t.error)throw new Error("login error");t.userId!==i._id&&(B(n("alreadyBoundAndSwitch")),h.clearCache(),await new Promise(()=>{setTimeout(()=>{location.reload()},2e3)}))}async function He(){const o=C=>{throw console.error(C),C},t=await it().catch(o);if(!t)throw new Error("no msg");const c=await ot(t).catch(o);if(!c)throw new Error("no sign");const g=await h.loginByBlockchain({msg:t,sig:c.signature,pubkey:c.pub_key}).catch(o);if(!g||g.error)throw new Error("no res");g.userId!==i._id&&(B(n("alreadyBoundAndSwitch")),h.clearCache(),await new Promise(()=>{setTimeout(()=>{location.reload()},2e3)}))}async function Ye(o){await h.unbind(o),await A()}async function k(o){var t;m[o]=!0;try{(t=i==null?void 0:i[o])!=null&&t.id?await Ye(o):await Ve(o),B.success(n("success")),A()}catch(c){console.error(c),B.error(n((c==null?void 0:c.error)||"fail"))}m[o]=!1}async function qe(){m.accessKey=!0;try{await h.regenAccessKey(),B.success(n("success")),A()}catch(o){console.error(o),B.error(n("fail"))}m.accessKey=!1}return(o,t)=>{var c,g,C,D,T,G,I,K,L,P,S,U,z,V,N,R,W,O,H,Y,q,J,Q,X,Z,j,ee,te,ae,ie,oe,ne,se,le,re,ce,de,ue,me,ge,ve,he,fe,pe,be,we,ye,_e,ke,Be,Ce,$e,xe,Fe,Ae,Ee,Me,De,Te,Ge,Ie,Ke;return s(),r(b,null,[a("div",st,[a("div",lt,l(e(n)("blockchain")),1),a("div",rt,[a("span",null,l(((g=(c=e(i))==null?void 0:c.blockchain)==null?void 0:g.id)||e(n)("notBound")),1),!((D=(C=e(i))==null?void 0:C.blockchain)!=null&&D.id)||ze.value>1?(s(),r("div",{key:0,class:"btn",onClick:t[0]||(t[0]=p=>k(e(u).Blockchain))},[m.blockchain?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((G=(T=e(i))==null?void 0:T.blockchain)!=null&&G.id?"unbind":"bind")),1)],64))])):v("",!0)])]),(I=d.value)!=null&&I.login.webAuthn?(s(),r("div",ct,[a("div",dt,l(e(n)("webAuthn"))+" ("+l(e(n)("fido"))+") ",1),a("div",ut,[a("div",mt,[a("span",null,l(((L=(K=e(i))==null?void 0:K.webAuthn)==null?void 0:L.id)||e(n)("notBound")),1)]),a("div",{class:"btn",onClick:t[1]||(t[1]=p=>k(e(u).WebAuthn))},[m.webAuthn?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((S=(P=e(i))==null?void 0:P.webAuthn)!=null&&S.id?"unbind":"bind")),1)],64))])])])):v("",!0),(U=d.value)!=null&&U.login.google?(s(),r("div",gt,[t[9]||(t[9]=a("div",{class:"item-label"}," Google ",-1)),a("div",vt,[a("div",ht,[(V=(z=e(i))==null?void 0:z.google)!=null&&V.avatar?(s(),r("img",{key:0,src:(R=(N=e(i))==null?void 0:N.google)==null?void 0:R.avatar,alt:(O=(W=e(i))==null?void 0:W.google)==null?void 0:O.name,class:"avatar"},null,8,ft)):v("",!0),a("span",null,l(((Y=(H=e(i))==null?void 0:H.google)==null?void 0:Y.name)||((J=(q=e(i))==null?void 0:q.google)==null?void 0:J.id)||e(n)("notBound")),1)]),a("div",{class:"btn",onClick:t[2]||(t[2]=p=>k(e(u).Google))},[m.google?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((X=(Q=e(i))==null?void 0:Q.google)!=null&&X.id?"unbind":"bind")),1)],64))])])])):v("",!0),(Z=d.value)!=null&&Z.login.gitee?(s(),r("div",pt,[M.value?(s(),r("div",bt,l(M.value),1)):v("",!0),t[10]||(t[10]=a("div",{class:"item-label"}," Gitee ",-1)),a("div",wt,[a("div",yt,[(ee=(j=e(i))==null?void 0:j.gitee)!=null&&ee.avatar?(s(),r("img",{key:0,src:(ae=(te=e(i))==null?void 0:te.gitee)==null?void 0:ae.avatar,alt:(oe=(ie=e(i))==null?void 0:ie.gitee)==null?void 0:oe.name,class:"avatar"},null,8,_t)):v("",!0),a("span",null,l(((se=(ne=e(i))==null?void 0:ne.gitee)==null?void 0:se.name)||((re=(le=e(i))==null?void 0:le.gitee)==null?void 0:re.id)||e(n)("notBound")),1)]),a("div",{class:"btn",onClick:t[3]||(t[3]=p=>k(e(u).Gitee))},[m.gitee?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((de=(ce=e(i))==null?void 0:ce.gitee)!=null&&de.id?"unbind":"bind")),1)],64))])])])):v("",!0),(ue=d.value)!=null&&ue.login.github?(s(),r("div",kt,[t[11]||(t[11]=a("div",{class:"item-label"}," Github ",-1)),a("div",Bt,[a("div",Ct,[(ge=(me=e(i))==null?void 0:me.github)!=null&&ge.avatar?(s(),r("img",{key:0,src:(he=(ve=e(i))==null?void 0:ve.github)==null?void 0:he.avatar,alt:(pe=(fe=e(i))==null?void 0:fe.github)==null?void 0:pe.name,class:"avatar"},null,8,$t)):v("",!0),a("span",null,l(((we=(be=e(i))==null?void 0:be.github)==null?void 0:we.name)||((_e=(ye=e(i))==null?void 0:ye.github)==null?void 0:_e.id)||e(n)("notBound")),1)]),a("div",{class:"btn",onClick:t[4]||(t[4]=p=>k(e(u).Github))},[m.github?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((Be=(ke=e(i))==null?void 0:ke.github)!=null&&Be.id?"unbind":"bind")),1)],64))])])])):v("",!0),(Ce=d.value)!=null&&Ce.login.mail?(s(),r("div",xt,[t[12]||(t[12]=a("div",{class:"item-label"}," Email ",-1)),a("div",Ft,[a("span",null,l(((xe=($e=e(i))==null?void 0:$e.mail)==null?void 0:xe.id)||e(n)("notBound")),1),a("div",{class:"btn",onClick:t[5]||(t[5]=p=>k(e(u).Mail))},[m.mail?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((Ae=(Fe=e(i))==null?void 0:Fe.mail)!=null&&Ae.id?"unbind":"bind")),1)],64))])]),a("div",{ref_key:"bindMailFmDom",ref:E,class:"bind-mail-fm flex column"},[Pe(a("input",{"onUpdate:modelValue":t[6]||(t[6]=p=>f.value.mail=p),type:"email",placeholder:e(n)("email")},null,8,At),[[Se,f.value.mail]]),Pe(a("input",{"onUpdate:modelValue":t[7]||(t[7]=p=>f.value.password=p),type:"password",placeholder:e(n)("password")},null,8,Et),[[Se,f.value.password]]),a("div",{class:"bind-mail-send",onClick:Re},l(F.value),1)],512)])):v("",!0),(Ee=d.value)!=null&&Ee.login.code?(s(),r("div",Mt,[t[13]||(t[13]=a("div",{class:"item-label"}," Code ",-1)),a("div",Dt,[a("span",null,l(((De=(Me=e(i))==null?void 0:Me.code)==null?void 0:De.id)||e(n)("notBound")),1),a("div",{class:"btn",onClick:t[8]||(t[8]=p=>k(e(u).Code))},[m.code?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)((Ge=(Te=e(i))==null?void 0:Te.code)!=null&&Ge.id?"unbind":"bind")),1)],64))])])])):v("",!0),a("div",Tt,[t[14]||(t[14]=a("div",{class:"item-label"}," AccessKey ",-1)),a("div",Gt,[a("span",null,l(((Ke=(Ie=e(i))==null?void 0:Ie.accessKey)==null?void 0:Ke.id)||e(n)("notBound")),1),a("div",{class:"btn",onClick:qe},[m.accessKey?(s(),w(_,{key:0})):(s(),r(b,{key:1},[y(l(e(n)("regen")),1)],64))])])])],64)}}});const Wt=tt(It,[["__scopeId","data-v-cf632085"]]);export{Wt as default};
