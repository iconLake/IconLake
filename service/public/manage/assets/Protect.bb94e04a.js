import{p as W,u as z,l as D}from"./project.3e053923.js";import{a as M,m as q,c as X,d as G}from"./blockchain.62e14144.js";import{H as J}from"./Header.5323aa62.js";import{g as U,I as K}from"./Icon.baf4c0eb.js";import{U as Q}from"./User.3e9238d3.js";import{d as Y,u as Z,E as aa,m as _,r as ea,p as F,o as na,c as r,a as C,b as u,t as h,e as f,l as L,f as m,v as ta,F as sa,i as oa,z as ia,k as c,_ as ca}from"./index.c3ac6b9b.js";import{I as la,t as d,D as $,f as A,O as ra}from"./cache.05004cf3.js";import{L as R}from"./Loading.7dd0339b.js";import{s as ua}from"./extension.dbd15d4c.js";import{u as da}from"./user.237cd0b6.js";import"./@iconlake/client.0b258216.js";import"./index.9c1809da.js";const ha={class:"main"},fa={key:0,class:"info"},pa=["title"],ka={key:1,class:"iconfont icon-close"},ba={class:"operate"},va=["loading","disabled"],ma={key:1},_a={key:1,class:"flex center links"},Ia=["href"],ga=["href"],ya={key:1,class:"warn flex start"},xa=Y({__name:"Protect",setup(Ca){const{t:i}=Z(),V=oa(),{userInfo:s,getUserInfo:B}=da(),H=aa(),p=_(H.params.projectId),I=_(H.params.id),a=ea({}),t=_(!1),w=_(!1),O=F(()=>{var n;return(n=a.blockchain)!=null&&n.txHash?`${la?"https://ping.pub/iconLake":"https://testnet.ping.pub/iconLake"}/tx/${a.blockchain.txHash}`:""}),g=F(()=>{var n,e;return((n=a.blockchain)==null?void 0:n.classId)&&((e=a.blockchain)==null?void 0:e.nftId)});async function j(){await W.getIcon(p.value,I.value).onUpdate(async n=>{Object.assign(a,n.info)})}async function E(){var l,k,b,v,N,P;if(t.value)return;if(!((l=s==null?void 0:s.gitee)!=null&&l.id)&&ia.global.locale.value==="zh-cn"){d.error(i("bindRequiredAccount"));return}t.value=!0;let n=U(a);if(!n){d.error(i("fail")),t.value=!1;return}if(n.startsWith($)){const y=await ua.getFile({key:n.substring($.length)});if(!y.data){d.error(i("fail")),t.value=!1;return}const x=await z({projectId:p.value,_id:y.key.replace(`${A.ICON}/`,""),data:y.data,dir:A.ICON},{storageType:"iconlake"});if(!x||!x.url){d.error(i("fail")),t.value=!1;return}n=x.url}const e=await M(n.replace(/\?.*/,""));if(!e||!s||!((k=s.blockchain)!=null&&k.id)){d.error(i("fail")),t.value=!1;return}const o=await q({creator:(b=s.blockchain)==null?void 0:b.id,classId:p.value,id:(v=e.graphHash)!=null?v:"",uri:n,uriHash:(N=e.fileHash)!=null?N:"",name:a.code,description:a.name,supply:"1"});if(!o){t.value=!1;return}if((o==null?void 0:o.code)!==0){d(i("blockchainConfirmationFailed"),"error"),t.value=!1;return}a.blockchain={classId:p.value,nftId:(P=e.graphHash)!=null?P:"",txHash:o.transactionHash,height:o.height},await D(p.value,I.value,{blockchain:a.blockchain}),d(i("blockchainConfirmationSuccessful"),"success"),t.value=!1}async function S(){var e,o;if(await B(),!((e=s==null?void 0:s.blockchain)!=null&&e.id))return;await X((o=s.blockchain)==null?void 0:o.id)&&(w.value=!0)}async function T(){var n,e,o;if(((n=a.blockchain)==null?void 0:n.classId)&&a.blockchain.nftId&&((e=s==null?void 0:s.blockchain)==null?void 0:e.id)){t.value=!0;const l=await G({creator:(o=s.blockchain)==null?void 0:o.id,classId:a.blockchain.classId,id:a.blockchain.nftId});if(!l){t.value=!1;return}if((l==null?void 0:l.code)!==0){console.error(l),d(i("burnFailed"),"error"),t.value=!1;return}await D(p.value,I.value,{blockchain:{classId:"",nftId:"",txHash:"",height:0}}),d(i("burnDone")),a.blockchain=void 0,t.value=!1}}return na(()=>{Promise.all([j(),S()]).finally(()=>{V.end()})}),(n,e)=>{var o,l,k,b,v;return c(),r(sa,null,[C(J,{back:`/icons/${p.value}`},null,8,["back"]),C(Q),u("div",ha,[u("p",null,h(f(i)("onChainVerifyOwnership")),1),f(U)(a)?(c(),r("div",fa,[C(K,{info:a,compress:{maxWidth:800,maxHeight:800}},null,8,["info"]),u("h1",null,h(a.name),1),u("h2",null,h(a.code),1),u("h3",null,"Created by "+h((l=(o=f(s))==null?void 0:o.blockchain)==null?void 0:l.id),1),g.value?(c(),r("div",{key:0,class:"burn flex center",title:f(i)("burnIcon"),onClick:T},[t.value?(c(),L(R,{key:0})):(c(),r("i",ka))],8,pa)):m("",!0)])):m("",!0),u("div",ba,[g.value?(c(),r("div",_a,[O.value?(c(),r("a",{key:0,target:"_blank",href:O.value,class:"success"},[e[0]||(e[0]=u("i",{class:"iconfont icon-info"},null,-1)),ta(" "+h(f(i)("OnchainRecord"))+"ID: "+h((k=a.blockchain)==null?void 0:k.txHash),1)],8,Ia)):m("",!0),((b=a.blockchain)==null?void 0:b.classId)&&((v=a.blockchain)==null?void 0:v.nftId)?(c(),r("a",{key:1,target:"_blank",class:"success exhibition",href:`${f(ra)}/exhibition/${a.blockchain.classId}/${a.blockchain.nftId}`},e[1]||(e[1]=[u("i",{class:"iconfont icon-exhibition"},null,-1)]),8,ga)):m("",!0)])):(c(),r("button",{key:0,class:"btn",loading:t.value,disabled:!w.value,onClick:E},[t.value?(c(),L(R,{key:0})):(c(),r("span",ma,h(f(i)("publishToBlockchain")),1))],8,va))]),g.value?m("",!0):(c(),r("div",ya,[e[2]||(e[2]=u("i",{class:"iconfont icon-warn"},null,-1)),u("p",null,h(f(i)("publishOriginalWorks")),1)]))])],64)}}});const Va=ca(xa,[["__scopeId","data-v-6651a557"]]);export{Va as default};
