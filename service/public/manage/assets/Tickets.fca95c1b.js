import{d as Z,u as K,E as Q,m as M,p as D,o as ee,c as d,a as T,e as C,f as k,b as I,t as S,F as j,h as b,i as te,k as h,q as L,A as ie,_ as se}from"./index.c3ac6b9b.js";import{U as oe}from"./User.3e9238d3.js";import{H as ne}from"./Header.5323aa62.js";import{u as P,t as ae,O as q}from"./cache.05004cf3.js";import{I as B,t as z}from"./Icon.baf4c0eb.js";import{u as re}from"./ticket.d2ccb1ce.js";import{d as U}from"./dayjs.min.794c16f3.js";import"./@iconlake/client.0b258216.js";import"./user.237cd0b6.js";import"./extension.dbd15d4c.js";import"./project.3e053923.js";function w(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}function $(t,s){for(var e=0;e<s.length;e++){var i=s[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function R(t,s,e){return s&&$(t.prototype,s),e&&$(t,e),t}function H(t){return+t.replace(/px/,"")}function ce(t){var s=window.devicePixelRatio,e=getComputedStyle(t),i=H(e.getPropertyValue("width")),n=H(e.getPropertyValue("height"));t.setAttribute("width",(i*s).toString()),t.setAttribute("height",(n*s).toString())}function p(t,s){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=Math.random()*(s-t)+t;return Math.floor(i*Math.pow(10,e))/Math.pow(10,e)}function V(t){return t[p(0,t.length)]}var ue=.00125,le=5e-4,de=9e-4,he=1e-5,fe=6,me=80,ve=.9,pe=1.7,_e=.2,ye=.6,Ce=.03,Ie=.07,W=15,X=82,ge=150,ke=100,Se=250,Ae=40,Fe=["#fcf403","#62fc03","#f4fc03","#03e7fc","#03fca5","#a503fc","#fc03ad","#fc03c2"];function Y(t){var s=1920;return Math.log(t)/Math.log(s)}var G=function(){function t(s){w(this,t);var e=s.initialPosition,i=s.direction,n=s.confettiRadius,o=s.confettiColors,r=s.emojis,l=s.emojiSize,u=s.canvasWidth,f=p(ve,pe,3),c=f*Y(u);this.confettiSpeed={x:c,y:c},this.finalConfettiSpeedX=p(_e,ye,3),this.rotationSpeed=r.length?.01:p(Ce,Ie,3)*Y(u),this.dragForceCoefficient=p(le,de,6),this.radius={x:n,y:n},this.initialRadius=n,this.rotationAngle=i==="left"?p(0,.2,3):p(-.2,0,3),this.emojiSize=l,this.emojiRotationAngle=p(0,2*Math.PI),this.radiusYUpdateDirection="down";var _=i==="left"?p(X,W)*Math.PI/180:p(-W,-X)*Math.PI/180;this.absCos=Math.abs(Math.cos(_)),this.absSin=Math.abs(Math.sin(_));var g=p(-ge,0),A={x:e.x+(i==="left"?-g:g)*this.absCos,y:e.y-g*this.absSin};this.currentPosition=Object.assign({},A),this.initialPosition=Object.assign({},A),this.color=r.length?null:V(o),this.emoji=r.length?V(r):null,this.createdAt=new Date().getTime(),this.direction=i}return R(t,[{key:"draw",value:function(e){var i=this.currentPosition,n=this.radius,o=this.color,r=this.emoji,l=this.rotationAngle,u=this.emojiRotationAngle,f=this.emojiSize,c=window.devicePixelRatio;o?(e.fillStyle=o,e.beginPath(),e.ellipse(i.x*c,i.y*c,n.x*c,n.y*c,l,0,2*Math.PI),e.fill()):r&&(e.font="".concat(f,"px serif"),e.save(),e.translate(c*i.x,c*i.y),e.rotate(u),e.textAlign="center",e.fillText(r,0,0),e.restore())}},{key:"updatePosition",value:function(e,i){var n=this.confettiSpeed,o=this.dragForceCoefficient,r=this.finalConfettiSpeedX,l=this.radiusYUpdateDirection,u=this.rotationSpeed,f=this.createdAt,c=this.direction,_=i-f;if(n.x>r&&(this.confettiSpeed.x-=o*e),this.currentPosition.x+=n.x*(c==="left"?-this.absCos:this.absCos)*e,this.currentPosition.y=this.initialPosition.y-n.y*this.absSin*_+ue*Math.pow(_,2)/2,this.rotationSpeed-=this.emoji?1e-4:he*e,this.rotationSpeed<0&&(this.rotationSpeed=0),this.emoji){this.emojiRotationAngle+=this.rotationSpeed*e%(2*Math.PI);return}l==="down"?(this.radius.y-=e*u,this.radius.y<=0&&(this.radius.y=0,this.radiusYUpdateDirection="up")):(this.radius.y+=e*u,this.radius.y>=this.initialRadius&&(this.radius.y=this.initialRadius,this.radiusYUpdateDirection="down"))}},{key:"getIsVisibleOnCanvas",value:function(e){return this.currentPosition.y<e+ke}}]),t}();function Ne(){var t=document.createElement("canvas");return t.style.position="fixed",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.style.zIndex="1000",t.style.pointerEvents="none",document.body.appendChild(t),t}function Te(t){var s=t.confettiRadius,e=s===void 0?fe:s,i=t.confettiNumber,n=i===void 0?t.confettiesNumber||(t.emojis?Ae:Se):i,o=t.confettiColors,r=o===void 0?Fe:o,l=t.emojis,u=l===void 0?t.emojies||[]:l,f=t.emojiSize,c=f===void 0?me:f;return t.emojies&&console.error("emojies argument is deprecated, please use emojis instead"),t.confettiesNumber&&console.error("confettiesNumber argument is deprecated, please use confettiNumber instead"),{confettiRadius:e,confettiNumber:n,confettiColors:r,emojis:u,emojiSize:c}}var je=function(){function t(s){var e=this;w(this,t),this.canvasContext=s,this.shapes=[],this.promise=new Promise(function(i){return e.resolvePromise=i})}return R(t,[{key:"getBatchCompletePromise",value:function(){return this.promise}},{key:"addShapes",value:function(){var e;(e=this.shapes).push.apply(e,arguments)}},{key:"complete",value:function(){var e;return this.shapes.length?!1:((e=this.resolvePromise)===null||e===void 0||e.call(this),!0)}},{key:"processShapes",value:function(e,i,n){var o=this,r=e.timeDelta,l=e.currentTime;this.shapes=this.shapes.filter(function(u){return u.updatePosition(r,l),u.draw(o.canvasContext),n?u.getIsVisibleOnCanvas(i):!0})}}]),t}(),Ee=function(){function t(){var s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};w(this,t),this.activeConfettiBatches=[],this.canvas=s.canvas||Ne(),this.canvasContext=this.canvas.getContext("2d"),this.requestAnimationFrameRequested=!1,this.lastUpdated=new Date().getTime(),this.iterationIndex=0,this.loop=this.loop.bind(this),requestAnimationFrame(this.loop)}return R(t,[{key:"loop",value:function(){this.requestAnimationFrameRequested=!1,ce(this.canvas);var e=new Date().getTime(),i=e-this.lastUpdated,n=this.canvas.offsetHeight,o=this.iterationIndex%10===0;this.activeConfettiBatches=this.activeConfettiBatches.filter(function(r){return r.processShapes({timeDelta:i,currentTime:e},n,o),o?!r.complete():!0}),this.iterationIndex++,this.queueAnimationFrameIfNeeded(e)}},{key:"queueAnimationFrameIfNeeded",value:function(e){this.requestAnimationFrameRequested||this.activeConfettiBatches.length<1||(this.requestAnimationFrameRequested=!0,this.lastUpdated=e||new Date().getTime(),requestAnimationFrame(this.loop))}},{key:"addConfetti",value:function(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=Te(e),n=i.confettiRadius,o=i.confettiNumber,r=i.confettiColors,l=i.emojis,u=i.emojiSize,f=this.canvas.getBoundingClientRect(),c=f.width,_=f.height,g=_*5/7,A={x:0,y:g},E={x:c,y:g},F=new je(this.canvasContext),a=0;a<o/2;a++){var m=new G({initialPosition:A,direction:"right",confettiRadius:n,confettiColors:r,confettiNumber:o,emojis:l,emojiSize:u,canvasWidth:c}),y=new G({initialPosition:E,direction:"left",confettiRadius:n,confettiColors:r,confettiNumber:o,emojis:l,emojiSize:u,canvasWidth:c});F.addShapes(m,y)}return this.activeConfettiBatches.push(F),this.queueAnimationFrameIfNeeded(),F.getBatchCompletePromise()}},{key:"clearCanvas",value:function(){this.activeConfettiBatches=[]}},{key:"destroyCanvas",value:function(){this.canvas.remove()}}]),t}();const be={key:0,class:"cover"},Pe={class:"info flex column center"},we={key:0,class:"title"},Re={key:1,class:"desc"},Oe={class:"ok"},xe={key:0,class:"tickets-title"},Me={key:1,class:"tickets"},De=["href","onClick"],Le={class:"cover"},qe={class:"info flex column center"},Be={class:"dots flex"},ze={key:0,class:"title"},Ue={key:1,class:"desc"},$e={class:"opts"},He=["onClick"],Ve={class:"expire flex"},We=Z({__name:"Tickets",setup(t){const s=te(),{t:e}=K(),i=Q(),n=M([]),o=M(),{passkey:r,setTicketPasskey:l}=re(),u=new Ee,f=D(()=>[...n.value.filter(a=>a.like.isLike)].sort((a,m)=>+new Date(a.like.time)<+new Date(m.like.time)?1:-1)),c=D(()=>[...n.value.filter(a=>!a.like.isLike)].reverse());function _(){setInterval(()=>{u.addConfetti({emojis:["\u{1F308}","\u26A1\uFE0F","\u{1F4A5}","\u2728","\u{1F4AB}","\u{1F338}","\u{1F337}","\u{1F339}","\u{1F33A}","\u{1F490}","\u{1F389}","\u{1F38A}","\u{1F31F}","\u{1F496}","\u{1F33C}","\u{1F33B}","\u{1F525}","\u{1F44F}","\u{1F64C}","\u{1F60D}","\u{1F970}","\u{1F618}","\u{1F929}","\u{1F973}"],emojiSize:50,confettiNumber:100})},500)}async function g(){if((i.query.pid||i.query.tid)&&i.query.code){const a=await P.claimTicket({projectId:i.query.pid,ticketId:i.query.tid,code:i.query.code}).catch(m=>(console.error(m),m));a.error||(o.value=a,_()),history.replaceState("","",`${window.location.origin}${window.location.pathname}`)}}async function A(){await P.getTickets().onUpdate(async a=>{n.value=a.tickets})}async function E(){var m,y;ae(e("loading"));const a=await l({_id:o.value._id,passkey:r.value});location.href=`${q}/exhibition/${(m=o.value)==null?void 0:m.projectId}?ticket=${(y=o.value)==null?void 0:y._id}&passkey=${a.passkey}`}async function F(a){a.like.isLike=!a.like.isLike,a.like.time=U().toISOString(),await P.likeTicket({_id:a._id,isLike:a.like.isLike}).catch(()=>{a.like.isLike=!a.like.isLike})}return ee(async()=>{await g(),await A(),s.end()}),(a,m)=>(h(),d(j,null,[T(ne,{back:!0}),T(oe),o.value?(h(),d("div",{key:0,class:"claimed",onClick:E},[o.value.project.cover?(h(),d("div",be,[T(B,{info:C(z)({img:{url:o.value.project.cover}}),compress:{maxWidth:600,maxHeight:600},lazy:!0},null,8,["info"])])):k("",!0),I("div",Pe,[o.value.project.name?(h(),d("div",we,S(o.value.project.name),1)):k("",!0),o.value.project.desc?(h(),d("div",Re,S(o.value.project.desc),1)):k("",!0)]),I("div",Oe,S(C(e)("go")),1)])):k("",!0),(h(!0),d(j,null,b([f.value,c.value],(y,O)=>{var x;return h(),d("div",{key:(x=y[0])==null?void 0:x._id,class:L(["tickets-wrapper",{"tickets-like":O===0,"tickets-unlike":O===1,blur:!!o.value}])},[y.length>0?(h(),d("div",xe,m[0]||(m[0]=[I("i",{class:"iconfont icon-heart"},null,-1)]))):k("",!0),y.length>0?(h(),d("div",Me,[(h(!0),d(j,null,b(y,v=>(h(),d("a",{key:v._id,class:"ticket",href:`${C(q)}/exhibition/${v.projectId}?ticket=${v._id}&passkey=${C(r)}`,target:"_blank",onClick:N=>C(l)({_id:v._id,passkey:C(r)})},[I("div",Le,[T(B,{info:C(z)({img:{url:v.project.cover}}),compress:{maxWidth:600,maxHeight:600},lazy:!0},null,8,["info"])]),I("div",qe,[I("div",Be,[(h(!0),d(j,null,b(new Array(15).map((N,J)=>J),N=>(h(),d("div",{key:N,class:"dot"}))),128))]),v.project.name?(h(),d("div",ze,S(v.project.name),1)):k("",!0),v.project.desc?(h(),d("div",Ue,S(v.project.desc),1)):k("",!0)]),I("div",$e,[I("i",{class:L(["iconfont icon-heart",{"active heartbeat":v.like.isLike}]),onClick:ie(N=>F(v),["prevent"])},null,10,He)]),I("div",Ve,S(C(e)("validUntil"))+S(C(U)(v.expired).format("YYYY-MM-DD HH:mm")),1)],8,De))),128))])):k("",!0)],2)}),128))],64))}});const ot=se(We,[["__scopeId","data-v-a5d3736e"]]);export{ot as default};
